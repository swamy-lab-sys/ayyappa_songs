{% extends 'base.html' %}
{% load static %}
{% block title %}Register | Swamiye Saranam Ayyappa{% endblock %}

{% block content %}
<div class="min-h-[85vh] flex items-center justify-center bg-gradient-to-br from-orange-50 via-amber-100 to-yellow-50 py-10 px-4">
  <div class="bg-white/90 backdrop-blur-md shadow-2xl rounded-3xl w-full max-w-md p-8 text-center border border-amber-200 animate-fadeIn relative overflow-hidden">

    <!-- Decorative Glow -->
    <div class="absolute -top-20 -right-20 w-60 h-60 bg-gradient-to-br from-orange-400 to-amber-500 opacity-20 blur-3xl rounded-full"></div>

    <!-- 🕉️ Header -->
    <div class="mb-6">
      <div class="flex justify-center">
        <i class="fa-solid fa-om text-amber-600 text-6xl drop-shadow-md animate-pulse"></i>
      </div>
      <h1 class="mt-4 text-3xl font-bold text-amber-800 tracking-wide">Create Devotional Account</h1>
      <p class="text-sm text-gray-500 mt-1">Join the Swamiye Saranam Ayyappa family</p>
    </div>

    <!-- 🧘 Registration Form -->
    <form id="registerForm" method="POST" class="space-y-5 text-left">
      {% csrf_token %}
      {% for field in form %}
      <div class="relative">
        <label for="{{ field.id_for_label }}" class="block text-sm font-semibold text-amber-700 mb-1">
          {{ field.label }}
        </label>

        <!-- Password Field Customization -->
        {% if field.name == 'password1' or field.name == 'password2' %}
          <div class="relative">
            {{ field }}
            <button type="button"
              class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-amber-600"
              onclick="togglePassword('{{ field.id_for_label }}', this)">
              <svg class="w-5 h-5 eye-open" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
              </svg>
              <svg class="w-5 h-5 eye-closed hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M3 3l3.59 3.59m7.532 7.532l3.29 3.29M3 3l3.59 3.59" />
              </svg>
            </button>
          </div>

          {% if field.name == 'password1' %}
            <!-- Password Strength Meter -->
            <div class="h-2 mt-2 bg-gray-200 rounded-full overflow-hidden">
              <div id="strength-bar" class="h-2 w-0 bg-red-500 transition-all duration-300"></div>
            </div>
            <p id="strength-text" class="text-xs mt-1 text-gray-500 italic">🔑 Enter a strong password</p>
          {% endif %}
        {% else %}
          {{ field }}
        {% endif %}
        <div class="error text-red-600 text-xs mt-1 font-medium"></div>
      </div>
      {% endfor %}

      {% if messages %}
        {% for message in messages %}
          <div class="p-3 mt-2 text-sm rounded-md 
            {% if message.tags == 'success' %}bg-green-100 text-green-700
            {% elif message.tags == 'error' %}bg-red-100 text-red-700
            {% else %}bg-yellow-100 text-yellow-700{% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}

      <div class="mt-6 flex flex-col sm:flex-row gap-3 justify-center">
        <button type="submit"
          class="px-6 py-3 w-full sm:w-auto bg-gradient-to-r from-orange-500 via-amber-600 to-orange-700 text-white font-semibold rounded-full shadow-lg hover:shadow-xl hover:scale-105 transition-all flex items-center justify-center gap-2">
          <i class="fa-solid fa-user-plus"></i> Register
        </button>

        <a href="{% url 'login' %}"
          class="px-6 py-3 w-full sm:w-auto bg-gray-100 text-gray-700 font-semibold rounded-full border border-gray-200 hover:bg-gray-200 hover:scale-105 transition-all flex items-center justify-center gap-2">
          <i class="fa-solid fa-right-to-bracket"></i> Login
        </a>
      </div>
    </form>

    <!-- 🪔 Footer -->
    <div class="mt-8 text-sm text-gray-500 italic">
      <p>🕯️ May Lord Ayyappan bless your new journey 🕯️</p>
    </div>
  </div>
</div>

<!-- 💫 Style Enhancements -->
<style>
  input, select, textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #fcd34d;
    border-radius: 8px;
    background-color: #fffdf5;
    transition: all 0.3s ease;
  }
  input:focus, select:focus {
    outline: none;
    border-color: #f59e0b;
    box-shadow: 0 0 6px rgba(245, 158, 11, 0.3);
  }
  .valid-field { border-color: #16a34a !important; box-shadow: 0 0 6px rgba(22, 163, 74, 0.3); }
  .invalid-field { border-color: #dc2626 !important; box-shadow: 0 0 6px rgba(220, 38, 38, 0.3); }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  .animate-fadeIn { animation: fadeIn 0.7s ease-in-out; }
</style>

<!-- 💡 jQuery + AJAX Validation + Password Strength -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(function () {
  const contactField = $("input[name='contact']");
  const passwordField = $("input[name='password1']");
  const strengthBar = $("#strength-bar");
  const strengthText = $("#strength-text");

  // 🔹 Live contact duplication check
  contactField.on("input", function () {
    const contact = $(this).val().trim();
    const errorDiv = contactField.siblings(".error");

    if (contact.length >= 10) {
      $.ajax({
        url: "{% url 'check_contact' %}",
        data: { contact: contact },
        success: function (response) {
          if (response.exists) {
            contactField.removeClass("valid-field").addClass("invalid-field");
            errorDiv.text("❌ This phone number is already registered.");
          } else {
            contactField.removeClass("invalid-field").addClass("valid-field");
            errorDiv.text("✅ This phone number is available.");
          }
        }
      });
    } else {
      contactField.removeClass("valid-field invalid-field");
      errorDiv.text("");
    }
  });

  // 🔹 Password Strength Meter
  passwordField.on("input", function () {
    const val = $(this).val();
    let strength = 0;

    if (val.length >= 8) strength++;
    if (/[A-Z]/.test(val)) strength++;
    if (/[a-z]/.test(val)) strength++;
    if (/[0-9]/.test(val)) strength++;
    if (/[^A-Za-z0-9]/.test(val)) strength++;

    const widths = ["0%", "20%", "40%", "60%", "80%", "100%"];
    const colors = ["bg-red-500", "bg-orange-500", "bg-yellow-500", "bg-lime-500", "bg-green-600"];

    strengthBar.removeClass().addClass("h-2 transition-all duration-300 rounded-full " + colors[strength - 1]);
    strengthBar.css("width", widths[strength]);

    const texts = ["", "Very Weak 😣", "Weak 😕", "Medium 🙂", "Strong 💪", "Very Strong 🔥"];
    strengthText.text(texts[strength]);
  });

  // 🔹 Show / Hide Password
  window.togglePassword = function (inputId, button) {
    const input = document.getElementById(inputId);
    const eyeOpen = button.querySelector(".eye-open");
    const eyeClosed = button.querySelector(".eye-closed");

    if (input.type === "password") {
      input.type = "text";
      eyeOpen.classList.add("hidden");
      eyeClosed.classList.remove("hidden");
    } else {
      input.type = "password";
      eyeOpen.classList.remove("hidden");
      eyeClosed.classList.add("hidden");
    }
  };
});
</script>
{% endblock %}
