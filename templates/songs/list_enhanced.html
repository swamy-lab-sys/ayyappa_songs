{% extends 'base.html' %}
{% load static %}

{% block title %}Song List{% endblock %}

{% block breadcrumb_extra %}
<span class="mx-2">›</span>
<span class="text-amber-700 font-medium">Songs</span>
{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/toast.css' %}">
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-8 py-8">
  
  <!-- Admin Navigation Bar -->
  {% if user.is_staff %}
  <div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-lg shadow-lg p-4 mb-6">
    <div class="flex flex-wrap items-center justify-between gap-4">
      <h2 class="text-white text-lg font-semibold flex items-center gap-2">
        <i class="fa-solid fa-shield-halved"></i> Admin Panel
      </h2>
      <div class="flex flex-wrap gap-2">
        <a href="{% url 'admin_users_dashboard' %}" class="px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg transition flex items-center gap-2">
          <i class="fa-solid fa-users"></i> Manage Users
        </a>
        <a href="{% url 'admin_access_requests' %}" class="px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg transition flex items-center gap-2 relative">
          <i class="fa-solid fa-inbox"></i> Access Requests
          {% if pending_requests_count > 0 %}
          <span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center">
            {{ pending_requests_count }}
          </span>
          {% endif %}
        </a>
        <a href="{% url 'admin_manage_access' %}" class="px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg transition flex items-center gap-2">
          <i class="fa-solid fa-key"></i> Bulk Access
        </a>
      </div>
    </div>
  </div>
  {% else %}
  <!-- User Navigation Bar -->
  <div class="bg-gradient-to-r from-amber-500 to-orange-500 rounded-lg shadow-lg p-4 mb-6">
    <div class="flex flex-wrap items-center justify-between gap-4">
      <h2 class="text-white text-lg font-semibold flex items-center gap-2">
        <i class="fa-solid fa-music"></i> My Songs
      </h2>
      <div class="flex flex-wrap gap-2">
        <a href="{% url 'my_requests' %}" class="px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg transition flex items-center gap-2">
          <i class="fa-solid fa-list-check"></i> My Requests
        </a>
        <a href="{% url 'song_add' %}" class="px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg transition flex items-center gap-2">
          <i class="fa-solid fa-plus"></i> Add Song
        </a>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Search & Filter Bar -->
  <div class="bg-white rounded-lg shadow-md p-5 mb-6">
    <form method="get" class="flex flex-wrap gap-3 items-end">
      <div class="flex-1 min-w-[200px]">
        <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
        <input 
          name="q" 
          value="{{ q }}" 
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-amber-400 focus:shadow-md focus:outline-none transition" 
          placeholder="Search by song name, lyrics, or owner...">
      </div>
      
      <div class="min-w-[150px]">
        <label class="block text-sm font-medium text-gray-700 mb-1">Language</label>
        <select name="language" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-amber-400 focus:outline-none">
          <option value="">All Languages</option>
          <option value="tamil" {% if language == "tamil" %}selected{% endif %}>Tamil</option>
          <option value="telugu" {% if language == "telugu" %}selected{% endif %}>Telugu</option>
          <option value="english" {% if language == "english" %}selected{% endif %}>English</option>
        </select>
      </div>
      
      <button type="submit" class="px-5 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-md shadow-md transition flex items-center gap-2">
        <i class="fa-solid fa-search"></i> Search
      </button>
      
      {% if q or language %}
      <a href="{% url 'song_list' %}" class="px-5 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-md transition flex items-center gap-2">
        <i class="fa-solid fa-xmark"></i> Clear
      </a>
      {% endif %}
    </form>
  </div>

  <!-- Song Grid -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    {% for song in page_obj.object_list %}
    <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition duration-300">
      <div class="p-5">
        <!-- Header -->
        <div class="flex items-start justify-between mb-3">
          <div>
            <h3 class="text-lg font-semibold text-amber-800">{{ song.get_title }}</h3>
            <div class="flex flex-wrap gap-2 mt-1">
              {% for lang_code, lang_name in song.available_languages %}
              <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800">
                {{ lang_name }}
              </span>
              {% endfor %}
            </div>
          </div>
        </div>
        
        <!-- Preview Lyrics -->
        <div class="text-sm text-gray-600 mb-4 line-clamp-3 italic">
          {{ song.get_lyrics|truncatewords:30 }}
        </div>
        
        <!-- Audio Player -->
        {% if song.get_audio_url %}
        <div class="mb-4">
          <audio controls class="w-full" style="height: 40px;">
            <source src="{{ song.get_audio_url }}" type="audio/mpeg">
            Your browser does not support the audio element.
          </audio>
        </div>
        {% endif %}
        
        <!-- Action Buttons -->
        <div class="flex flex-wrap gap-2">
          {% if user.is_staff or song.owner == user or song.id in user_access_ids %}
            <!-- User has access -->
            <a href="{% url 'song_view' song.id %}" class="flex-1 px-3 py-2 bg-amber-600 hover:bg-amber-700 text-white text-center rounded-md transition text-sm">
              <i class="fa-solid fa-eye"></i> View
            </a>
            {% if user.is_staff or song.owner == user %}
            <a href="{% url 'song_edit' song.id %}" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition text-sm">
              <i class="fa-solid fa-edit"></i> Edit
            </a>
            <a href="{% url 'song_download_pdf' song.id %}" class="px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-md transition text-sm" title="Download PDF">
              <i class="fa-solid fa-file-pdf"></i>
            </a>
            {% else %}
            <a href="{% url 'song_download_pdf' song.id %}" class="px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-md transition text-sm" title="Download PDF">
              <i class="fa-solid fa-file-pdf"></i>
            </a>
            {% endif %}
          {% else %}
            <!-- User does NOT have access -->
            {% if song.id in user_pending_request_ids %}
              <button disabled class="flex-1 px-3 py-2 bg-yellow-100 text-yellow-800 text-center rounded-md text-sm cursor-not-allowed">
                <i class="fa-solid fa-clock"></i> Request Pending
              </button>
            {% else %}
              <button 
                onclick="requestAccess({{ song.id }}, '{{ song.display_title|escapejs }}')"
                class="flex-1 px-3 py-2 bg-red-600 hover:bg-red-700 text-white text-center rounded-md transition text-sm">
                <i class="fa-solid fa-lock"></i> Request Access
              </button>
            {% endif %}
          {% endif %}
        </div>
        
        <!-- Metadata -->
        <div class="mt-3 pt-3 border-t border-gray-200 text-xs text-gray-500 flex justify-between">
          <span><i class="fa-solid fa-user"></i> {{ song.owner.username }}</span>
          <span><i class="fa-solid fa-play-circle"></i> {{ song.play_count }} plays</span>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-span-2 text-center py-16 text-gray-500">
      <i class="fa-solid fa-music text-6xl mb-4 text-gray-300"></i>
      {% if user.is_staff %}
        <p class="text-lg">No songs found.</p>
      {% else %}
        <p class="text-lg mb-2">🪔 No songs available yet.</p>
        <p class="text-sm text-gray-400">Request access from admin to view songs.</p>
        <a href="{% url 'my_requests' %}" class="inline-block mt-4 px-6 py-3 bg-amber-600 hover:bg-amber-700 text-white rounded-md transition">
          <i class="fa-solid fa-list-check"></i> View My Requests
        </a>
      {% endif %}
    </div>
    {% endfor %}
  </div>

  <!-- Pagination -->
  {% if page_obj.paginator.num_pages > 1 %}
  <div class="mt-8 flex justify-center">
    <nav class="flex items-center gap-2">
      {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}&q={{ q }}&language={{ language }}" 
           class="px-3 py-2 border border-gray-300 rounded-md hover:bg-gray-50 transition text-sm">
          <i class="fa-solid fa-chevron-left"></i> Previous
        </a>
      {% endif %}
      
      <span class="px-4 py-2 bg-amber-100 text-amber-800 rounded-md font-medium text-sm">
        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
      </span>
      
      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}&q={{ q }}&language={{ language }}" 
           class="px-3 py-2 border border-gray-300 rounded-md hover:bg-gray-50 transition text-sm">
          Next <i class="fa-solid fa-chevron-right"></i>
        </a>
      {% endif %}
    </nav>
  </div>
  {% endif %}

</div>

{% csrf_token %}

<script src="{% static 'js/app.js' %}"></script>
<script>
// Request Access Function
function requestAccess(songId, songTitle) {
  if (!confirm(`Request access to "${songTitle}"?`)) {
    return;
  }
  
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  
  fetch(`/request-access/${songId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken,
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast('✅ ' + data.message, 'success');
      setTimeout(() => location.reload(), 1500);
    } else {
      showToast('❌ ' + (data.error || 'Failed to send request'), 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('⚠️ Network error occurred', 'error');
  });
}
</script>
{% endblock %}
