{% extends 'base.html' %}
{% load static %}

{% block title %}My Access Requests{% endblock %}

{% block breadcrumb_extra %}
<span class="mx-2">‚Ä∫</span>
<span class="text-amber-700 font-medium">My Requests</span>
{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/toast.css' %}">
{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 sm:px-8 py-8">
  
  <!-- Header -->
  <div class="bg-gradient-to-r from-amber-500 to-orange-500 rounded-lg shadow-lg p-6 mb-6 text-white">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold mb-2">
          <i class="fa-solid fa-list-check"></i> My Access Requests
        </h1>
        <p class="text-white/90">Track the status of your song access requests</p>
      </div>
      <a href="{% url 'song_list' %}" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg transition">
        <i class="fa-solid fa-arrow-left"></i> Back to Songs
      </a>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-white rounded-lg shadow-md p-5 border-l-4 border-yellow-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-500 text-sm font-medium">Pending</p>
          <p class="text-3xl font-bold text-gray-800">{{ stats.pending }}</p>
        </div>
        <div class="text-yellow-500 text-4xl">
          <i class="fa-solid fa-clock"></i>
        </div>
      </div>
    </div>
    
    <div class="bg-white rounded-lg shadow-md p-5 border-l-4 border-green-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-500 text-sm font-medium">Approved</p>
          <p class="text-3xl font-bold text-gray-800">{{ stats.approved }}</p>
        </div>
        <div class="text-green-500 text-4xl">
          <i class="fa-solid fa-circle-check"></i>
        </div>
      </div>
    </div>
    
    <div class="bg-white rounded-lg shadow-md p-5 border-l-4 border-red-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-500 text-sm font-medium">Denied</p>
          <p class="text-3xl font-bold text-gray-800">{{ stats.denied }}</p>
        </div>
        <div class="text-red-500 text-4xl">
          <i class="fa-solid fa-circle-xmark"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Filter Tabs -->
  <div class="bg-white rounded-lg shadow-md mb-6">
    <div class="flex border-b border-gray-200">
      <a href="?status=all" 
         class="px-6 py-3 text-sm font-medium {% if filter_status == 'all' %}text-amber-600 border-b-2 border-amber-600{% else %}text-gray-500 hover:text-gray-700{% endif %} transition">
        All Requests ({{ stats.total }})
      </a>
      <a href="?status=pending" 
         class="px-6 py-3 text-sm font-medium {% if filter_status == 'pending' %}text-yellow-600 border-b-2 border-yellow-600{% else %}text-gray-500 hover:text-gray-700{% endif %} transition">
        üü° Pending ({{ stats.pending }})
      </a>
      <a href="?status=approved" 
         class="px-6 py-3 text-sm font-medium {% if filter_status == 'approved' %}text-green-600 border-b-2 border-green-600{% else %}text-gray-500 hover:text-gray-700{% endif %} transition">
        ‚úÖ Approved ({{ stats.approved }})
      </a>
      <a href="?status=denied" 
         class="px-6 py-3 text-sm font-medium {% if filter_status == 'denied' %}text-red-600 border-b-2 border-red-600{% else %}text-gray-500 hover:text-gray-700{% endif %} transition">
        ‚ùå Denied ({{ stats.denied }})
      </a>
    </div>
  </div>

  <!-- Requests List -->
  <div class="bg-white rounded-lg shadow-md overflow-hidden">
    {% if requests %}
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gradient-to-r from-amber-100 to-orange-100">
          <tr>
            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Song</th>
            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Status</th>
            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Requested</th>
            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Reviewed</th>
            <th class="px-6 py-4 text-center text-sm font-semibold text-gray-700">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          {% for request in requests %}
          <tr class="hover:bg-amber-50 transition-colors">
            <td class="px-6 py-4">
              <div>
                <p class="font-semibold text-gray-800">{{ request.song.display_title }}</p>
                <p class="text-sm text-gray-500">Owner: {{ request.song.owner.username }}</p>
                {% if request.message %}
                <p class="text-xs text-gray-400 mt-1 italic">Message: {{ request.message|truncatewords:15 }}</p>
                {% endif %}
              </div>
            </td>
            <td class="px-6 py-4">
              {% if request.status == 'pending' %}
              <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-medium">
                üü° Pending
              </span>
              {% elif request.status == 'approved' %}
              <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                ‚úÖ Approved
              </span>
              {% else %}
              <span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-medium">
                ‚ùå Denied
              </span>
              {% endif %}
            </td>
            <td class="px-6 py-4 text-sm text-gray-600">
              {{ request.requested_at|date:"M d, Y" }}<br>
              <span class="text-xs text-gray-400">{{ request.requested_at|time:"g:i A" }}</span>
            </td>
            <td class="px-6 py-4 text-sm text-gray-600">
              {% if request.reviewed_at %}
                {{ request.reviewed_at|date:"M d, Y" }}<br>
                <span class="text-xs text-gray-400">by {{ request.reviewed_by.username }}</span>
              {% else %}
                <span class="text-gray-400">-</span>
              {% endif %}
            </td>
            <td class="px-6 py-4 text-center">
              {% if request.status == 'approved' %}
                <a href="{% url 'song_view' request.song.id %}" 
                   class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm transition inline-flex items-center gap-2">
                  <i class="fa-solid fa-eye"></i> View Song
                </a>
              {% elif request.status == 'pending' %}
                <span class="text-sm text-gray-400">Waiting...</span>
              {% else %}
                <button 
                  onclick="requestAccess({{ request.song.id }}, '{{ request.song.display_title|escapejs }}')"
                  class="px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg text-sm transition">
                  <i class="fa-solid fa-rotate"></i> Request Again
                </button>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="text-center py-16">
      <i class="fa-solid fa-inbox text-6xl text-gray-300 mb-4"></i>
      <p class="text-lg text-gray-500 mb-2">No requests found</p>
      <p class="text-sm text-gray-400 mb-6">
        {% if filter_status == 'all' %}
          You haven't requested access to any songs yet.
        {% else %}
          No {{ filter_status }} requests.
        {% endif %}
      </p>
      <a href="{% url 'song_list' %}" class="inline-block px-6 py-3 bg-amber-600 hover:bg-amber-700 text-white rounded-lg transition">
        <i class="fa-solid fa-music"></i> Browse Songs
      </a>
    </div>
    {% endif %}
  </div>

  <!-- Pagination -->
  {% if page_obj.has_other_pages %}
  <div class="mt-6 flex justify-center">
    <nav class="flex items-center gap-2">
      {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}&status={{ filter_status }}" 
           class="px-3 py-2 border border-gray-300 rounded-md hover:bg-gray-50 transition text-sm">
          <i class="fa-solid fa-chevron-left"></i> Previous
        </a>
      {% endif %}
      
      <span class="px-4 py-2 bg-amber-100 text-amber-800 rounded-md font-medium text-sm">
        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
      </span>
      
      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}&status={{ filter_status }}" 
           class="px-3 py-2 border border-gray-300 rounded-md hover:bg-gray-50 transition text-sm">
          Next <i class="fa-solid fa-chevron-right"></i>
        </a>
      {% endif %}
    </nav>
  </div>
  {% endif %}

</div>

{% csrf_token %}

<script src="{% static 'js/app.js' %}"></script>
<script>
// Request Access (for re-requesting denied songs)
function requestAccess(songId, songTitle) {
  if (!confirm(`Request access to "${songTitle}" again?`)) {
    return;
  }
  
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  
  fetch(`/songs/request-access/${songId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken,
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast('‚úÖ ' + data.message, 'success');
      setTimeout(() => location.reload(), 1500);
    } else {
      showToast('‚ùå ' + (data.error || 'Failed to send request'), 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('‚ö†Ô∏è Network error occurred', 'error');
  });
}
</script>
{% endblock %}
